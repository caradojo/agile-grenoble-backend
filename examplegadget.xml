<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Fetch JSON Example"/>
  <Content type="html">
  <![CDATA[
        <link rel="stylesheet" type="text/css" href="https://dl.dropbox.com/u/84602525/agile-grenoble-backend/program.css" />
        <table cellpadding="0" cellspacing="0" class="program">
            <tbody id="program_content">
            </tbody>
        </table>

        
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script type="text/javascript">

    function makeJSONRequest() {    
      var params = {};
      params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
      // This URL returns a JSON-encoded string that represents a JavaScript object
      //var url = "https://dl.dropbox.com/u/84602525/agile-grenoble-backend/program.json";
      var url = "http://sessions.agile-grenoble.org:8080/json/program-summary-with-roomlist";
      gadgets.io.makeRequest(url, response, params);
    };

    function response(obj) { 
      var program = obj.data;
      
var room_map = {
    "Auditorium":{"id": 0, "capacity" : 530},
    "Makalu": {"id":1, "capacity" : 110},  
    "Kilimanjaro 1": {"id":2, "capacity" : 50},
    "Kilimanjaro 3": {"id":3, "capacity" : 50},
    "Mont Blanc 1": {"id":4, "capacity" : 25},
    "Mont Blanc 3+2": {"id":5, "capacity" : 50},
    "Mont Blanc 4": {"id":6, "capacity" : 25},
    "Cervin": {"id":7, "capacity" : 40},
    "Everest": {"id":8, "capacity" : 40}
};

var slot_hours = [
    "8h00",
    "8h30",
    "9h00",
    "10h00",
    "10h50",
    "11h10",
    "12h00",
    "13h35",
    "13h45",
    "14h50",
    "15h40",
    "16h10",
    "17h00",
    "17h20",
    "18h30"
];

format_program(program);

function format_program(program) {
    var slot_id = 0;
    var previous_was_plenary = false;
    $.each(program["slots"], function(islot, slot) {
        if (!slot.all && !previous_was_plenary) {
            $('#program_content').append(change_room(slot_id));
            slot_id++;
        }

        var session_html = '<td>'+slot_hours[slot_id]+'</td>';
        format_slot(slot_id, slot, session_html);
        
        previous_was_plenary = false;
        if (slot.all) {
            previous_was_plenary = true;
        }
        slot_id++;
    });
}

function format_slot(slot_id, slot, session_html) {
    if (slot.all) {
        format_plenary(session_html, slot);
    } else {
        prefill_empty_cells(session_html, slot_id);

        $.each(slot, function (room, session) {
            $('#'+slot_id+'_'+room_map[room].id).append(format_session(session));
        });
    }
}

function get_rooms_slot() {
    var session_html = '<td> </td>';
    $.each(room_map, function (room_name, room) {
        session_html += '<td>'+room_name+'<br />('+room.capacity+' places)</td>';
    });
    return '<tr class="room_desc">'+session_html+'</tr>';
}

function format_plenary(session_html, slot) {
    var it_was_keynote = false;
    // there is only one key
    $.each(slot, function (room, session) {
        if (session.type == 'keynote') {
            it_was_keynote = true;
        }
        session_html += '<td colspan="9" class="plenary '+session.type+'">'+format_session(session)+'</td>';
    });
    $('#program_content').append('<tr>'+session_html+'</tr>');

    if (it_was_keynote) {
        $('#program_content').append(get_rooms_slot());
    }
}

function change_room(slot_id) {
    var session_html = '<td>'+slot_hours[slot_id]+'</td>';
    session_html += '<td colspan="9">Changement de salle</td>';
    return '<tr class="change_room">'+session_html+'</tr>';
}

function prefill_empty_cells(session_html, slot_id) {
    $.each(room_map, function (room_name, room) {
        session_html += '<td id="'+slot_id+'_'+room.id+'">&nbsp;</td>';
    });
    $('#program_content').append('<tr>'+session_html+'</tr>');    
}

function format_session(session) {
    var session_title = '<span class="session_title">'+session['title']+'</span> ';
    var session_url   = session_title;
    if (session.id) {
        session_url = '<a href="#'+session['id']+'">'+session_title+'</a>';
    }
    
    session_content = session_url;
    if (session['speakers']) {
        session_content += '<span class="session_speakers">'+session['speakers'].join(', ')+'</span>';
    }
    return session_content;
}


   };
     
     gadgets.util.registerOnLoadHandler(makeJSONRequest);
     </script>
  ]]>
  </Content>
</Module>
